From 4b504628fa0e378db599b5e1823558306400a1b3 Mon Sep 17 00:00:00 2001
From: =?UTF-8?q?Julian=20R=C3=BCth?= <julian.rueth@fsfe.org>
Date: Mon, 7 Oct 2019 19:24:07 +0200
Subject: [PATCH] Add conda prefix to search paths

---
 python/cppyy/__init__.py       | 8 ++++++++
 python/cppyy/_cpython_cppyy.py | 9 ++++++++-
 2 files changed, 16 insertions(+), 1 deletion(-)

diff --git a/python/cppyy/__init__.py b/python/cppyy/__init__.py
index 131d857..23bf6dc 100644
--- a/python/cppyy/__init__.py
+++ b/python/cppyy/__init__.py
@@ -203,6 +203,14 @@ if not ispypy:
         else:
             add_include_path(apipath_extra)
 
+if os.getenv('CONDA_PREFIX'):
+    # macOS, Linux
+    include_path = os.path.join(os.getenv('CONDA_PREFIX'), 'include')
+    if os.path.exists(include_path): add_include_path(include_path)
+    # Windows
+    include_path = os.path.join(os.getenv('CONDA_PREFIX'), 'Library', 'include')
+    if os.path.exists(include_path): add_include_path(include_path)
+
 del ispypy, apipath
 
 def add_autoload_map(fname):
diff --git a/python/cppyy/_cpython_cppyy.py b/python/cppyy/_cpython_cppyy.py
index 0a333e3..17fa5f9 100644
--- a/python/cppyy/_cpython_cppyy.py
+++ b/python/cppyy/_cpython_cppyy.py
@@ -100,8 +100,15 @@ gbl.std.move  = _backend.move
 #- add to the dynamic path as needed -----------------------------------------
 import os
 def add_default_paths():
+    gSystem = gbl.gSystem
+    if os.getenv('CONDA_PREFIX'):
+        # macOS, Linux
+        lib = os.path.join(os.getenv('CONDA_PREFIX'), 'lib')
+        if os.path.exists(lib): gSystem.AddDynamicPath(lib)
+        # Windows
+        lib = os.path.join(os.getenv('CONDA_PREFIX'), 'Library', 'lib')
+        if os.path.exists(lib): gSystem.AddDynamicPath(lib)
     try:
-        gSystem = gbl.gSystem
         with open('/etc/ld.so.conf') as ldconf:
             for line in ldconf:
                 f = line.strip()
-- 
2.23.0

